!function(a,b,c){c.ScrollSequence=function(b){this.element=a(b),this.data=[],this.state="",this.element&&this.parseSequenceData(this.element.data("seq"))},c.ScrollSequence.prototype=b.extend({parseSequenceData:function(a){var b=c.SimpleObject.parse(a);if(!b||!b.length)return console.warn("No sequence data found."),void 0;for(var d=0,e=b.length;e>d;d++){var f=b[d];if(!f.steps||!f.set)return console.error("Invalid sequence definition for",this.element[0],"Missing steps & setter."),void 0}this.data=b},findFrameIndex:function(a,b){var c=a.steps,d=0/0,e=0/0;if(b<=c[0])return[0/0,0];if(b>=c[c.length-1])return[c.length-1,0/0];for(var f=0,g=c.length;g>f;f++){var h=c[f];(isNaN(d)&&b>h||b>h&&h>=d)&&(d=f),!isNaN(d)&&isNaN(e)&&h>=b&&(e=f)}return[d,e]},setCSSValue:function(a,b,c,d){switch((null===d||void 0===d)&&(d=""),b){case"translate":case"translate3d":case"translateX":case"translateY":case"translateZ":case"rotateX":case"rotateY":case"rotateZ":case"perspective":var e=a.transform||(a.transform="");e+=c instanceof Array?" "+b+"("+c.join(d+" ")+d+")":" "+b+"("+c+d+")",a["-webkit-transform"]=e,a["-moz-transform"]=e,a["-o-transform"]=e,a["-ms-transform"]=e,a.transform=e;break;case"background-image":a["background-image"]="url(/../images/test/"+c+")";break;default:a[b]=c instanceof Array?c.join(d+" ")+d:c+d}},setValuesByIndex:function(a,b,d){b.steps.length;for(var e in b.set){var f=b.set[e];f instanceof c.UnitValuesObject&&(0>d?this.setCSSValue(a,e,f.values[0],f.unit):d>=f.values.length?this.setCSSValue(a,e,f.values[f.values.length-1],f.unit):this.setCSSValue(a,e,f.values[d],f.unit))}},interpolateFrameValues:function(a,b,d,e,f){var g=b.steps,h=0,i=0,j=0,k=0,l=0;0>j&&(j=0),j>1&&(j=1);for(var m in b.set){var n=b.set[m];if(n instanceof c.UnitValuesObject){if(n.values.length===g.length)k=n.values[d],l=n.values[e],h=g[d],i=g[e];else{if(2!==n.values.length)continue;k=n.values[0],l=n.values[1],h=g[0],i=g[g.length-1]}if(isNaN(parseFloat(k)))-1!=m.indexOf("background-image")&&this.setCSSValue(a,m,k,n.unit);else{j=(f-h)/(i-h),0>j&&(j=0),j>1&&(j=1);var o=k+(l-k)*j;"px"==n.unit&&(o=Math.round(o)),this.setCSSValue(a,m,o,n.unit)}}}},update:function(a){var b,c,d,e={};for(b=0,c=this.data.length;d=this.data[b];b++){var f=this.findFrameIndex(d,a),g=f[0],h=f[1];isNaN(g)||isNaN(h)?!isNaN(g)&&isNaN(h)?this.setValuesByIndex(e,d,g):isNaN(g)&&!isNaN(h)?this.setValuesByIndex(e,d,h):console.error("Possible error with keyframe definition.",d):this.interpolateFrameValues(e,d,g,h,a)}this.element.css(e)}},c.Object),c.Ruleset=function(b){this.element=a(b),this.data=null,this.rules=[],this.start=-1,this.end=-1,this.element&&this.parseRulesetData(this.element.data("rset"))},c.Ruleset.prototype=b.extend({parseRulesetData:function(a){for(var b=c.SimpleObject.parse(a),d=0;d<b.length;d++){var e=b[d];isNaN(e.between)||isNaN(e.and)||this.rules.push(e)}this.rules.sort(function(a,b){return a.between<b.between?-1:1}),this.rules.length&&(this.start=this.rules[0].between,this.end=this.rules[this.rules.length-1].and)},ensure:function(a){var b=this;this.rules.forEach(function(c){switch(c.rule){case"has_class":a>=c.between&&a<c.and?b.element.hasClass(c.class_name)||b.element.addClass(c.class_name):b.element.removeClass(c.class_name);break;case"is_displayed":a>=c.between&&a<c.and?b.element.css("display",c.display||"block"):b.element.css("display","none")}})}},c.Object),c.Sequencer=b.extend({sequences:[],rulesets:[],$window:a(window),raf:null,prevUpdate:-1,rebuild:function(){console.log("Sequences: Rebuilding sequence indexes."),this.sequences=[],this.initialize()},clear:function(){this.update(0),a("[data-seq]").each(function(){}),this.sequences=[],this.rulesets=[],console.log("preview.Sequencer: Cleared.")},initialize:function(){var b=this,d=a(window);a("[data-seq]").each(function(a,d){var e=new c.ScrollSequence(d);e.data.length&&b.sequences.push(e)}),a("[data-rset]").each(function(a,d){var e=new c.Ruleset(d);e.rules.length&&b.rulesets.push(e)}),b.rulesets.sort(function(a,b){return a.start<b.start?-1:1}),console.log("preview.Sequencer: Initialized with",this.sequences.length,"sequence(s) and",this.rulesets.length,"ruleset(s)"),this.raf=function(){return window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame}(),"function"==typeof this.raf?(console.log("preview.Sequencer: Using requestAnimationFrame"),this.raf.call(window,this.updateForNextFrame)):(console.log("preview.Sequencer: Using on window scroll"),d.bind("scroll",this.updateForNextFrame)),this.updateForNextFrame()},updateForNextFrame:function(){var a=c.Sequencer.$window.scrollTop();0>a&&(a=0),c.Sequencer.prevUpdate!==a&&(c.Sequencer.update(a),c.Sequencer.prevUpdate=a),"function"==typeof c.Sequencer.raf&&c.Sequencer.raf.call(window,c.Sequencer.updateForNextFrame)},update:function(a){var b,c,d,e;for(b=0;c=this.sequences.length,d=this.sequences[b];b++)d.update(a);for(b=0;c=this.rulesets.length,e=this.rulesets[b];b++)e.ensure(a)}},c.Object)}(window.jQuery,window._,window.preview);