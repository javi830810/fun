'use strict';

var path = require('path');
var fs = require('fs');
var delim = require('./regexrules');

function _getRegex(type, def) {
  var isRegex = typeof delim[type][def] === 'string' || delim[type][def] instanceof RegExp;
  return isRegex ?
    new RegExp(delim[type][def],'gi') :
    new RegExp(delim[type][def].start + '((?:.|\n|\r)*?)' + delim[type][def].end,'gi');
}

function _process(src, type, srcDir) {
  src = src.toString();
  type = type || 'html';

  // process src
  src = src.replace(_getRegex(type, 'include'), function (match, file, include) {
    file = (file || '').trim();
    var includedSource = fs.readFileSync(path.join(srcDir, file));
    includedSource = _process(includedSource, type);
    return includedSource || match + ' not found';
  });

  return src;
}

exports.processFileSync = function (src, filepath) {
  var type = path.extname(filepath).slice(1);
  var srcDir = path.dirname(filepath);
  return _process(src, type, srcDir);
};
